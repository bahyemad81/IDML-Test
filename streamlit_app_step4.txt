
# STEP 4: Edit and Enhance Text
elif st.session_state.step == 4:
    show_stepper(4)
    
    st.markdown('<div class="content-card">', unsafe_allow_html=True)
    
    st.markdown("### âœï¸ Review & Edit Translations")
    
    if not st.session_state.translations:
        st.warning("No translations available to edit.")
        if st.button("â† Back"):
            st.session_state.step = 3
            st.rerun()
    else:
        # Navigation
        total_segments = len(st.session_state.translations)
        
        col1, col2, col3 = st.columns([1, 2, 1])
        
        with col1:
            if st.button("â† Previous", disabled=st.session_state.current_segment == 0):
                st.session_state.current_segment = max(0, st.session_state.current_segment - 1)
                st.rerun()
        
        with col2:
            st.markdown(f"<div style='text-align: center; padding: 0.5rem;'><strong>Segment {st.session_state.current_segment + 1} of {total_segments}</strong></div>", unsafe_allow_html=True)
        
        with col3:
            if st.button("Next â†’", disabled=st.session_state.current_segment >= total_segments - 1):
                st.session_state.current_segment = min(total_segments - 1, st.session_state.current_segment + 1)
                st.rerun()
        
        st.markdown("---")
        
        # Current segment
        current = st.session_state.translations[st.session_state.current_segment]
        
        # Display original and translated text
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("**Original Text:**")
            st.info(current['original'])
        
        with col2:
            st.markdown("**Translated Text:**")
            edited_text = st.text_area(
                "Edit translation",
                value=current['translated'],
                height=150,
                key=f"edit_{st.session_state.current_segment}",
                label_visibility="collapsed"
            )
            
            if edited_text != current['translated']:
                if st.button("ğŸ’¾ Save Changes", type="primary"):
                    st.session_state.translations[st.session_state.current_segment]['translated'] = edited_text
                    st.success("âœ… Changes saved!")
                    time.sleep(0.5)
                    st.rerun()
        
        st.markdown("---")
        
        # Action buttons
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("â† Back to Translation"):
                st.session_state.step = 3
                st.rerun()
        
        with col2:
            jump_to = st.number_input("Jump to segment:", min_value=1, max_value=total_segments, value=st.session_state.current_segment + 1, key="jump")
            if st.button("Go"):
                st.session_state.current_segment = jump_to - 1
                st.rerun()
        
        with col3:
            if st.button("Apply & Download â†’", type="primary"):
                # Apply all edits and regenerate files
                with st.spinner("Applying changes..."):
                    try:
                        translator = IDMLTranslator(target_lang=st.session_state.target_lang)
                        translator.translation_pairs = st.session_state.translations
                        
                        # Apply edits to the IDML file
                        updated_paths = translator.apply_edits(
                            st.session_state.output_paths['idml'],
                            st.session_state.translations
                        )
                        
                        st.session_state.output_paths = updated_paths
                        st.success("âœ… Changes applied successfully!")
                        time.sleep(1)
                        st.session_state.step = 3  # Go back to download
                        st.rerun()
                    except Exception as e:
                        st.error(f"âŒ Failed to apply changes: {str(e)}")
    
    st.markdown('</div>', unsafe_allow_html=True)

